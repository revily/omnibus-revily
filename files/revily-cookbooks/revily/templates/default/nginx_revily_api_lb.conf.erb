server {
  listen <%= @server_port %>;
  server_name <%= @server_name %>;
  access_log /var/log/revily/nginx/access.log opscode;

  <% if @server_proto == "https" -%>
  ssl on;
  ssl_certificate <%= @ssl_certificate %>;
  ssl_certificate_key <%= @ssl_certificate_key %>;

  ssl_session_timeout 5m;

  ssl_protocols <%= @ssl_protocols %>;
  ssl_ciphers <%= @ssl_ciphers %>;
  ssl_prefer_server_ciphers on;

  <% end -%>
  root <%= File.join(@dir, "html") %>;

  client_max_body_size <%= @client_max_body_size %>;

  proxy_set_header Host $host:$server_port;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto <%= @server_proto %>;
  proxy_pass_request_headers on;
  proxy_connect_timeout   1;
  proxy_send_timeout      300;
  proxy_read_timeout      300;

  error_page 404 =404 /404.html;
  error_page 503 =503 /503.json;

  location /nginx_status {
    stub_status on;
    access_log   off;
    allow 127.0.0.1;
    deny all;
  }

  location /version {
    types { }
    default_type text/plain;
    alias /opt/revily/version-manifest.txt;
  }

  location /docs {
    index index.html ;
    alias /opt/revily/docs;
  }

  location ~ "^/(?:stylesheets|javascripts|images|facebox|css|favicon|robots|humans)/{0,1}.*$" {
    proxy_pass http://revily_web;
    proxy_pass_request_headers off;
    proxy_cache web-cache;
    proxy_cache_valid 200 302 300m;
    proxy_cache_valid 404 1m;
  }

 location = /_status {
    proxy_pass http://revily_api/_status;
  }
  
  location / {
    set $my_upstream revily_api;
    proxy_redirect http://$my_upstream /;
    proxy_pass http://$my_upstream;
  }

  location /dashboard {
    set $my_upstream revily_web;
    proxy_redirect http://$my_upstream /;
    proxy_pass http://$my_upstream;
  }
}
